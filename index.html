<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      margin: 0;
      background: #0b0b0b;
      background-image: radial-gradient(#1a1a1a 1px, transparent 1px);
      background-size: 6px 6px;
      color: #cfcfcf;
      font-family: Arial, "Segoe UI", sans-serif;
    }

    .container {
  max-width: 1200px;
  width: 100%;
  padding: 16px;
  margin: 0 auto;
  box-sizing: border-box;
}

    .panel {
      border: 1px solid #6b6430;
      background: linear-gradient(#141414, #0c0c0c);
      padding: 10px 12px 12px;
      margin-bottom: 14px;
    }

    .panel-title {
      color: #f1dc55;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .stats-summary {
  margin-bottom: 16px;
  padding: 12px;
  background: #0a0a0a;
  border: 1px solid #555;
  border-radius: 8px;
  color: #f1dc55;
  font-size: 14px;
  line-height: 1.5;
}
    .options {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.btn {
  padding: 6px 12px;
  border-radius: 6px;
  border: 1px solid #d1c45c;
  background: linear-gradient(135deg, #f1dc55, #e0c24f);
  color: #000;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s ease;
  white-space: nowrap;
}

/* hover */
.btn:hover {
  background: linear-gradient(135deg, #fff3a3, #f1d35c);
  box-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
  transform: translateY(-1px);
}

/* í´ë¦­ */
.btn:active {
  transform: translateY(1px);
  box-shadow: none;
}

/* ì„ íƒ ìƒíƒœ */
.btn.active {
  background: #88FF88;
  border-color: #88FF88;
  color: #000;
  box-shadow: 0 0 8px rgba(136, 255, 136, 0.6);
}

/* ë¹„í™œì„± */
.btn.disabled {
  opacity: 0.25;
  pointer-events: none;
  border-color: #444;
  color: #555;
  background: #222;
  box-shadow: none;
  transform: none;
}

/* ì´ˆê¸°í™” ë²„íŠ¼ë§Œ ì‚´ì§ ë‹¤ë¥´ê²Œ */
.btn.reset {
  font-size: 12px;
  padding: 5px 10px;
  background: linear-gradient(135deg, #ff4d4d, #b30000);
  border-color: #ff4d4d;
  color: #000;
}

/* hover */
.btn.reset:hover {
  background: linear-gradient(135deg, #ff6666, #cc0000);
  box-shadow: 0 0 10px rgba(255, 0, 0, 0.6);
}
.btn.ok { 
  font-size: 12px;
  padding: 5px 10px;
  background: linear-gradient(135deg, #4dff88, #00b33c);
  border-color: #00cc44;
  color: #003300;
}
.btn.ok:hover {
  background: linear-gradient(135deg, #66ffaa, #00cc44);
  box-shadow: 0 0 10px rgba(0, 255, 100, 0.6);
}
/* active */
.btn.reset:active {
  background: linear-gradient(135deg, #cc0000, #800000);
}
    
    /* ê²°ê³¼ ì¹´ë“œ ë˜í¼ */
.result-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 16px;
}

/* ì¹´ë“œ */
.result-card {
  border: 1px solid #6b6430;
  background: linear-gradient(#161616, #0d0d0d);
  padding: 8px 10px;
  border-radius: 4px;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
}

/* ì´ë¦„ */
.result-name {
  color: #f1dc55;
  font-size: 13px;
  font-weight: 700;
  margin-bottom: 4px;
}

/* ì˜µì…˜ í…ìŠ¤íŠ¸ */
.result-option {
  font-size: 13px;
  color: #cfcfcf;
  line-height: 1.4;
}

/* ê²°ê³¼ ì—†ìŒ */
.hint {
  color: #777;
  font-size: 20px;
}
.result-card {
  background: linear-gradient(135deg, #111, #1b1b1b);
  border: 1px solid #3a3a3a;
  border-radius: 8px;
  padding: 14px;
  color: #fff;
  width: 300px;
  box-sizing: border-box;
}

/* ìƒë‹¨ */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.card-title {
  font-size: 15px;
  font-weight: 700;
  color: #fff;
}

.card-grade {
  font-size: 12px;
  padding: 3px 7px;
  border-radius: 6px;
  background: #2a2a2a;
  color: #ccc;
}

.card-options {
  display: flex;
  gap: 6px;
  margin: 8px 0;
  flex-wrap: wrap;
}

.option-tag {
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 4px;
  background: #2a2a2a;
  color: #ccc;
  transition: 0.2s;
}

.option-tag.selected {
  background: #88FF88;
  color: #000;
  font-weight: 600;
}

/* ì§€ì—­ */
.card-desc {
  font-size: 12px;
  color: #aaa;
}
.result-list {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;   /* â­ ì´ê²Œ í•µì‹¬ */
}
.result-card {
  background: linear-gradient(#151515, #0e0e0e);
  border: 1px solid #333;
  border-radius: 10px;
  padding: 14px;
  box-sizing: border-box;
}
/* 6ì„± */
.grade-6 {
  border-color: #ff2a2a;
  box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
}

/* 5ì„± */
.grade-5 {
  border-color: #ffd700;
  box-shadow: 0 0 12px rgba(255, 215, 0, 0.7);
}
.card-image {
  width: 100%;
  height: 160px;
  overflow: hidden;
  border-radius: 8px;
  margin-bottom: 8px;
}

.card-image img {
  width: 100%;
  height: 100%;
  object-fit: contain;   /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ì›€ */
  display: block;
}
.result-card.excluded {
  filter: grayscale(100%);
  opacity: 0.35;
  transform: scale(0.97);
  transition: 0.2s;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.header-buttons {
  display: flex;
  gap: 8px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
}
/* ì „ì²´ ì»¨í…Œì´ë„ˆ ë ˆì´ì•„ì›ƒ */
.toggle-wrapper {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 5px 12px;
  background: rgba(0, 0, 0, 0.2); /* ë°°ê²½ì— ì‚´ì§ ìŒì˜ */
  border-radius: 8px;
  border: 1px solid #00cc44;
  width: fit-content;
  gap: 15px;
}
.toggle-wrapper .data-btn {
  background-color: #007bff; /* íŒŒë€ìƒ‰ ë°°ê²½ */
  color: white;              /* ê¸€ììƒ‰ í°ìƒ‰ */
  border: 1px solid #0056b3; /* ì¡°ê¸ˆ ë” ì§„í•œ íŒŒë€ìƒ‰ í…Œë‘ë¦¬ */
}

/* ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ(Hover) íš¨ê³¼ */
.toggle-wrapper .data-btn:hover {
  background-color: #0056b3; /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ë” ì§„í•˜ê²Œ */
}
.toggle-text {
  font-size: 12px;
  color: #4dff88; /* í…ìŠ¤íŠ¸ë„ ë²„íŠ¼ ìƒ‰ìƒê³¼ í†µì¼ */
  font-weight: bold;
}

/* ìŠ¤ìœ„ì¹˜ ë³¸ì²´ */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 22px;
}

/* ì²´í¬ë°•ìŠ¤ ìˆ¨ê¸°ê¸° */
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* ìŠ¬ë¼ì´ë” ë°°ê²½ (OFF ìƒíƒœ) */
.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background: #333; /* êº¼ì¡Œì„ ë•ŒëŠ” ì–´ë‘¡ê²Œ */
  transition: .3s;
  border-radius: 22px;
  border: 1px solid #444;
}

/* ìŠ¬ë¼ì´ë” ë‚´ë¶€ ì› */
.toggle-slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 3px;
  bottom: 2px;
  background: #bbb;
  transition: .3s;
  border-radius: 50%;
}

/* ğŸŸ¢ ì²´í¬ë˜ì—ˆì„ ë•Œ (ON ìƒíƒœ) - .btn.ok ìŠ¤íƒ€ì¼ ì ìš© */
input:checked + .toggle-slider {
  background: linear-gradient(135deg, #4dff88, #00b33c);
  border-color: #00cc44;
  box-shadow: 0 0 10px rgba(0, 255, 100, 0.4);
}

input:checked + .toggle-slider:before {
  transform: translateX(20px);
  background: #fff; /* ONì¼ ë•Œ ì›ì„ í•˜ì–—ê²Œ ê°•ì¡° */
  box-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
}

/* í˜¸ë²„ íš¨ê³¼ */
.toggle-wrapper:hover {
  box-shadow: 0 0 10px rgba(0, 255, 100, 0.3);
  transition: 0.3s;
}
.top-nav{
  display:flex;
  gap:12px;
  justify-content:center;
  margin-bottom:20px;
}

.nav-btn{
  background:#1f2937;
  border:1px solid #374151;
  color:#cbd5e1;
  padding:10px 18px;
  border-radius:12px;
  cursor:pointer;
  font-size:14px;
  transition:.2s;
}

.nav-btn:hover{
  background:#2b3a55;
  transform:translateY(-2px);
}

.nav-btn.active{
  background:#3b82f6;
  border:none;
  color:white;
  box-shadow:0 0 12px rgba(59,130,246,.5);
}
  </style>
</head>
<body>
<div class="top-nav">
  <button class="nav-btn active" onclick="goPage('index')">ğŸ§® ê¸°ì§ˆ íŒŒë°</button>
  <button class="nav-btn" onclick="goPage('daily')">ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸</button>
</div>
<div class="container">

  <div class="panel">
    <div class="panel-header">
    <div class="panel-title">ê¸°ì´ˆ ì˜µì…˜</div>
     <div class="toggle-wrapper">
      <button class="data-btn" onclick="exportToJSON()">ğŸ“¥ ì €ì¥í•˜ê¸°</button>
  <input type="file" id="importFile" style="display:none;" onchange="importFromJSON(event)" accept=".json">
  <button class="data-btn" onclick="document.getElementById('importFile').click()">ğŸ“¤ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <span class="toggle-text">íŒŒë° ì™„ë£Œ</span>
  <label class="toggle-switch">
    <input type="checkbox" id="showExcluded">
    <span class="toggle-slider"></span>
    </label>
</div>
    
  </div>
    <div class="options" id="primary"></div>
  </div>

  <div class="panel">
    <div class="panel-title">ì¶”ê°€ ì˜µì…˜</div>
    <div class="options" id="secondary"></div>
  </div>

  <div class="panel">
    <div class="panel-title">ìŠ¤í‚¬ ì˜µì…˜</div>
    <div class="options" id="skill"></div>
  </div>
  <div class="panel">
    <div class="panel-title">ì§€ì—­</div>
    <div class="options" id="area"></div>
  </div>
  <div class="panel">
  <div class="panel-title">ë¬´ê¸°</div>
  <div id="stats-summary" class="stats-summary"></div>
    <div id="result" class="result-list"></div>
</div>
</div>

<script>

let dbdata = [];
let optiondata = {};
let currentResult = [];
let primaryStrings = [];
let subStrings = [];
let excludedIds = new Set(JSON.parse(localStorage.getItem("excludedCards") || "[]"));
let viewMode = "normal";

document.querySelectorAll(".nav-btn")[0].classList.add("active");
const selected = {
  primary: [],
  secondary: null,
  skill: null,
  area: null
};

function parseOptions(field){
  if(!field) return [];

  return field
    .toString()
    .split(/[,/|]/)
    .map(v=>normalizeText(v))
    .filter(v=>v.length>0);
}

function goPage(page){

  // GAS ì›¹ì•±ì¸ì§€ í™•ì¸
  if (location.hostname.includes("script.google.com")) {

    // í˜„ì¬ URL ìœ ì§€í•˜ë©´ì„œ page íŒŒë¼ë¯¸í„°ë§Œ êµì²´
    const url = new URL(window.location.href);
    url.searchParams.set('page', page);
    window.location.replace(url.toString());

  } else {

    // GitHub Pages (ì •ì  html ì´ë™)
    window.location.href = page + ".html";

  }
}

async function loadData() {
  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbyX7jhg84E-sji4QVrCzSFXDccLY4rCM51OK5oKNpUtOxtu510OesOTLqCLUtoIC__ijg/exec?v=" + new Date().getTime());
    const data = await res.json();

    dbdata = data.db;
    optiondata = data.options;
    
    init();
    setTimeout(updateResult, 0);

  } catch (err) {
    console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
  }
}

loadData();

function init() {
  createButtons("primary", optiondata.primary, true);
  createButtons("secondary", optiondata.secondary, true);
  createButtons("skill", optiondata.skill, true);
  createButtons("area", optiondata.area, true);

  const toggleBtn = document.getElementById("showExcluded");

  toggleBtn.addEventListener("change", function () {
    if (this.checked) {
      viewMode = "excluded";
    } else {
      viewMode = "normal";
    }
    updateResult();
    updateOptionAvailability();
    getRemainingWeapons();
  });

  // â­ ì´ ì¤„ ì¶”ê°€
  //updateResult();
}

function createButtons(type, list, single) {
    
  const wrap = document.getElementById(type);
  wrap.innerHTML = "";
  // ì˜µì…˜ ë²„íŠ¼ë“¤
  list.forEach(value => {
    const btn = document.createElement("div");
    btn.className = "btn";
    btn.textContent = value;
    btn.onclick = () => toggle(type, value, btn );
    wrap.appendChild(btn);
  });
}

function isActive(value, selected) {
  return value && value === selected ? 'style="background:#f1dc55;color:#000;border-color:#f1dc55"' : '';
}

function updateResult() {

  const best = getBestFarmingArea();
  const remainweapon = getRemainingWeapons(); // â† ë§¤ë²ˆ ìƒˆë¡œ ê³„ì‚°
  const total = dbdata.length;
  const cleared = total - remainweapon.length;

 let percent = 0;
 if (total > 0) {
  percent = Math.floor(cleared / total * 100);
 }
  const resultEl = document.getElementById("result");
  resultEl.innerHTML = "";
  const statsEl = document.getElementById("stats-summary")
  statsEl.innerHTML = `
  ğŸ“Š ì¶”ì²œ ì˜µì…˜<br>
  ìŠ¤íƒ¯ ì˜µì…˜: <strong>${'ì—†ìŒ'}</strong><br>
  ìŠ¤í‚¬ ì˜µì…˜: <strong>${'ì—†ìŒ'}</strong><br>
  ì¶”ì²œ íŒŒë°ì§€ì—­:<strong>${best ? best.area + " (ë‚˜ì˜¤ëŠ” ë¬´ê¸°" + best.count + "ê°œ)" : "ì—†ìŒ"}</strong><br>
  ë¬´ê¸° í˜„í™©: <strong>${cleared} / ${total} (${percent}%)</strong>
  
 `;
  // 1. ì„ íƒ ì—¬ë¶€ í™•ì¸
  const hasPrimary = selected.primary && selected.primary.length > 0;
  const isAnySelected = hasPrimary || !!selected.secondary || !!selected.skill || !!selected.area;

  let result = [];
  
  // =========================
  // ğŸ“¦ íšë“ë§Œ ë³´ê¸° ëª¨ë“œ
  // =========================
  if (viewMode === "excluded") {
    result = dbdata.filter(row => excludedIds.has(row["ì´ë¦„"]));
    if (result.length === 0) {
      resultEl.innerHTML = `<div class="hint">íŒŒë° ì™„ë£Œí•œ ë¬´ê¸° ì—†ìŒ</div>`;
      return;
    }
  } else {
    // =========================
    // ğŸ¯ viewMode = normal
    // =========================
    if (!isAnySelected) {
            resultEl.innerHTML = `<div class="hint" >ğŸ” ê¸°ì´ˆ ì˜µì…˜ì´ë‚˜ ì§€ì—­ì„ ì„ íƒí•˜ë©´ ë¬´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>`;
      return;
    } else {
      result = dbdata.filter(row => {
        // ğŸ”¥ excluded ìˆ¨ê¹€
        if (excludedIds.has(row["ì´ë¦„"])) return false;

        const rowOpts = [
        ...parseOptions(row["ì˜µì…˜1"]),
        ...parseOptions(row["ì˜µì…˜2"]),
        ...parseOptions(row["ì˜µì…˜3"])
        ];

        // A. Primary ê²€ì‚¬: ì„ íƒëœ ê¸°ì´ˆ ì˜µì…˜ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ í†µê³¼ (OR)
        const passPrimary = !hasPrimary || selected.primary.some(sel => rowOpts.includes(sel.trim()));

        // B. ë‚˜ë¨¸ì§€ ê²€ì‚¬: Secondary, Skill, AreaëŠ” ì„ íƒëœ ê²½ìš° ëª¨ë‘ ë§Œì¡±í•´ì•¼ í•¨ (AND)
        const otherCategories = {
          secondary: selected.secondary,
          skill: selected.skill,
          area: selected.area
        };

        const passOthers = Object.entries(otherCategories).every(([type, sel]) => {
          if (!sel) return true; // ì„ íƒ ì•ˆ í–ˆìœ¼ë©´ í†µê³¼
          if (type === "area") return row["ì§€ì—­"] && row["ì§€ì—­"].includes(sel);
          return rowOpts.includes(sel.trim());
        });

        // ê¸°ì´ˆ ì˜µì…˜ ì¡°ê±´ê³¼ ê¸°íƒ€ ì¡°ê±´ì´ ëª¨ë‘ ë§ì•„ì•¼ ìµœì¢… í‘œì‹œ
        return passPrimary && passOthers;
      });
      // ==========================================
  // ğŸ“Š 1. í†µê³„ ê³„ì‚° ë¡œì§ ì¶”ê°€
  // ==========================================
  const countPrimary = {};
  const countSub = {};
 // 1. í˜„ì¬ ì„ íƒëœ ì˜µì…˜ë“¤ì„ í•˜ë‚˜ì˜ ì§‘í•©ìœ¼ë¡œ í•©ì¹˜ê¸° (ì œì™¸ìš©)
  const mySelected = new Set();
  
  // Primaryê°€ ë°°ì—´ì¸ ê²½ìš° (ë‹¤ì¤‘ ì„ íƒ)
  if (Array.isArray(selected.primary)) {
    selected.primary.forEach(v => mySelected.add(v.trim()));
  }
  // Secondary, Skill ë“±ì´ ë‹¨ì¼ ë¬¸ìì—´ì¸ ê²½ìš°
  ["secondary", "skill"].forEach(type => {
    if (selected[type]) mySelected.add(selected[type].trim());
  });
  result.forEach(row => {
    // ì˜µì…˜1 í†µê³„
    parseOptions(row["ì˜µì…˜1"]).forEach(opt=>{
  countPrimary[opt] = (countPrimary[opt] || 0) + 1;
 });
    
    // ì˜µì…˜2, ì˜µì…˜3 í†µí•© í†µê³„ (ì¤‘ë³µ ë‹¨ì–´ 1ê°œ ì¶”ì¶œìš©)
    [...parseOptions(row["ì˜µì…˜2"]), ...parseOptions(row["ì˜µì…˜3"])]
  .forEach(opt=>{
    if(!mySelected.has(opt)){
      countSub[opt] = (countSub[opt] || 0) + 1;
    }
  });
  });

  // ë¹ˆë„ìˆ˜ ë†’ì€ ìˆœ ì •ë ¬ (ê°’ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ)
  const sortedPrimary = Object.entries(countPrimary)
  .sort((a, b) => b[1] - a[1]);

 let topPrimary = [];

 if(sortedPrimary.length){

  // 3ìœ„ ì ìˆ˜(ì»·ë¼ì¸)
  const cutoffIndex = Math.min(2, sortedPrimary.length - 1);
  const cutoffScore = sortedPrimary[cutoffIndex][1];

  // ì»·ë¼ì¸ ì´ìƒ ì „ë¶€ í¬í•¨
  topPrimary = sortedPrimary.filter(e => e[1] >= cutoffScore);
 }

  const sortedSub = Object.entries(countSub)
  .sort((a, b) => b[1] - a[1]);

 const maxSubCount = sortedSub.length ? sortedSub[0][1] : 0;
  // ìµœê³ ê°’ê³¼ ê°™ì€ ì• ë“¤ ì „ë¶€ ì„ íƒ
 const topSub = sortedSub.filter(e => e[1] === maxSubCount);
 const topSubSet = new Set(topSub.map(e=>e[0]));
 Object.keys(countPrimary).forEach(k=>delete countPrimary[k]);

 result.forEach(row=>{

  const hasTopSub =
    parseOptions(row["ì˜µì…˜2"]).some(opt=>topSubSet.has(opt)) ||
    parseOptions(row["ì˜µì…˜3"]).some(opt=>topSubSet.has(opt));

  if(!hasTopSub) return;

  // ì—¬ê¸°ë¶€í„° ì˜µì…˜1 ì¹´ìš´íŠ¸
  parseOptions(row["ì˜µì…˜1"]).forEach(opt=>{
    countPrimary[opt] = (countPrimary[opt]||0)+1;
  });

 });
 primaryStrings = topPrimary.map(e => `${e[0]}(${e[1]})`);
 subStrings = topSub.map(e => `${e[0]}(${e[1]})`);
  const statsEl = document.getElementById("stats-summary");
 let optionText = "ì—†ìŒ";
 let topText = "ì—†ìŒ";

 if(selected.area){
  const rec = getAreaOptionRecommendation(selected.area);

  if(rec){
    optionText = rec.top3
  .map(opt => `${opt}(${rec.top3Count[opt]||0})`)
  .join(', ');

topText = `${rec.bestOption} (${rec.score}ê°œ)`;
  }
 }
  statsEl.innerHTML = `
  ğŸ“Š ì¶”ì²œ ì˜µì…˜<br>
  ìŠ¤íƒ¯ ì˜µì…˜: <strong>${optionText}</strong><br>
  ìŠ¤í‚¬ ì˜µì…˜: <strong>${topText}</strong><br>
  ì¶”ì²œ íŒŒë°ì§€ì—­:<strong>${best ? best.area + " (ë‚˜ì˜¤ëŠ” ë¬´ê¸°" + best.count + "ê°œ)" : "ì—†ìŒ"}</strong><br>
  ë¬´ê¸° í˜„í™©: <strong>${cleared} / ${total} (${percent}%)</strong>
  `;
 
    }
  }
  
  result.forEach(row => {
    const card = document.createElement("div");
    const grade = row["ì„±ê¸‰"];
    const id = row["ì´ë¦„"];

    card.className = "result-card grade-" + grade.replace("ì„±", "");
    card.dataset.id = id;

    if (excludedIds.has(id)) {
      card.classList.add("excluded");
    }

    // ìš°í´ë¦­ ì œì™¸ ë¡œì§
    card.addEventListener("contextmenu", function (e) {
      e.preventDefault();
      if (excludedIds.has(id)) {
        excludedIds.delete(id);
        card.classList.remove("excluded");
        updateResult();
        
      } else {
        excludedIds.add(id);
        card.classList.add("excluded");
      }
      localStorage.setItem("excludedCards", JSON.stringify([...excludedIds]));
      if (viewMode === "normal" && excludedIds.has(id)) {
        card.remove();
        renderStats();
        updateResult();
      }
      
    });

    const baseUrl = "https://cdn.jsdelivr.net/gh/kuu6132/end-field@main/%EB%AC%B4%EA%B8%B0/";
    const imageUrl = row["ì´ë¦„"]
      ? baseUrl + encodeURIComponent(row["ì´ë¦„"])
      : "https://via.placeholder.com/300x375?text=No+Image";

    card.innerHTML = `
      <div class="card-image"><img src="${imageUrl}.png"></div>
      <div class="card-header">
        <div class="card-title">${row["ì´ë¦„"]}</div>
        <div class="card-grade">${row["ì„±ê¸‰"]}</div>
      </div>
      <div class="card-options">
        <span class="option-tag ${isSelected(row["ì˜µì…˜1"]) ? "selected" : ""}">
          ${row["ì˜µì…˜1"] ?? ""}
        </span>
        <span class="option-tag ${isSelected(row["ì˜µì…˜2"]) ? "selected" : ""}">
          ${row["ì˜µì…˜2"] ?? ""}
        </span>
        <span class="option-tag ${isSelected(row["ì˜µì…˜3"]) ? "selected" : ""}">
          ${row["ì˜µì…˜3"] ?? ""}
        </span>
      </div>
      <div class="card-desc">${row["ì§€ì—­"] ?? ""}</div>
    `;

    resultEl.appendChild(card);
  });
  currentResult = result; // resultëŠ” ì„ íƒí•´ì„œ ë‚˜ì˜¨ ê²°ê³¼ê°’
  updateOptionAvailability();
}

function isSelected(optionValue) {
    if (!optionValue) return false;
    const val = optionValue.trim();
    return (
      (selected.primary && selected.primary.includes(val)) || // ë°°ì—´ì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
      val === selected.secondary ||
      val === selected.skill ||
      (selected.area && val === selected.area.trim())
    );
}

function calculateAreaScore(areaName){

  const remaining = getRemainingWeapons(); // íŒŒë° ì•ˆí•œ ë¬´ê¸°
  const target = normalizeText(areaName);

  /* 1ï¸âƒ£ í•´ë‹¹ ì§€ì—­ ë¬´ê¸°ë§Œ ì¶”ì¶œ */
  const areaWeapons = remaining.filter(row=>{
    if(!row["ì§€ì—­"]) return false;

    const areas = String(row["ì§€ì—­"])
      .replace(/\u00A0/g,' ')
      .split(',')
      .map(a=>normalizeText(a));

    return areas.includes(target);
  });

  if(areaWeapons.length === 0) return 0;


  /* 2ï¸âƒ£ ì§€ì—­ ë‚´ë¶€ì—ì„œ ì˜µì…˜2+3 ìµœë‹¤ì˜µì…˜ ì°¾ê¸° */
  const subCount = {};

  areaWeapons.forEach(row=>{
    [...parseOptions(row["ì˜µì…˜2"]), ...parseOptions(row["ì˜µì…˜3"])]
      .forEach(opt=>{
        subCount[opt] = (subCount[opt] || 0) + 1;
      });
  });

  const sortedSub = Object.entries(subCount)
    .sort((a,b)=>b[1]-a[1]);

  if(!sortedSub.length) return 0;

  const topSub = sortedSub[0][0];


  /* 3ï¸âƒ£ ê·¸ ìµœë‹¤ì˜µì…˜ì„ ê°€ì§„ ë¬´ê¸°ë§Œ ë‚¨ê¹€ */
  const filteredWeapons = areaWeapons.filter(row=>
    parseOptions(row["ì˜µì…˜2"]).includes(topSub) ||
    parseOptions(row["ì˜µì…˜3"]).includes(topSub)
  );


  /* 4ï¸âƒ£ ê·¸ ë¬´ê¸°ë“¤ ê¸°ì¤€ ì˜µì…˜1 TOP3 ê³„ì‚° */
  const primaryCount = {};

  filteredWeapons.forEach(row=>{
    parseOptions(row["ì˜µì…˜1"]).forEach(opt=>{
      primaryCount[opt] = (primaryCount[opt] || 0) + 1;
    });
  });

  const topPrimary = Object.entries(primaryCount)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,3)
    .map(e=>e[0]);

  const topPrimarySet = new Set(topPrimary);


  /* 5ï¸âƒ£ TOP3 ì˜µì…˜ì„ ê°€ì§„ ë¬´ê¸° ê°œìˆ˜ */
  let score = 0;

  filteredWeapons.forEach(row=>{
    const hasPrimary =
      parseOptions(row["ì˜µì…˜1"])
        .some(opt => topPrimarySet.has(opt));

    if(hasPrimary) score++;
  });

  return score;
}

function normalizeAreaName(name){
  if(!name) return "";

  name = normalizeText(name);

  // ëª¨ë“  ê³µë°± ì œê±° í›„ ë¹„êµ
  const key = name.replace(/\s/g,'');

  if(key.includes("ê±°ì ")) return "ê±°ì  ì§€ì—­";
  if(key.includes("ì—°êµ¬")) return "ì˜¤ë¦¬ì§€ëŠ„ ì—°êµ¬ êµ¬ì—­";
  if(key.includes("ê´‘ë§¥")) return "ê´‘ë§¥ êµ¬ì—­";
  if(key.includes("ì—ë„ˆì§€")) return "ì—ë„ˆì§€ ê³µê¸‰ ê³ ì§€";
  if(key.includes("ë¬´ë¦‰")) return "ë¬´ë¦‰ì„±";

  return name;
}

function getBestFarmingArea(){

  const areas = [
    "ê±°ì  ì§€ì—­",
    "ì˜¤ë¦¬ì§€ëŠ„ ì—°êµ¬ êµ¬ì—­",
    "ê´‘ë§¥ êµ¬ì—­",
    "ì—ë„ˆì§€ ê³µê¸‰ ê³ ì§€",
    "ë¬´ë¦‰ì„±"
  ];

  let bestArea = null;
  let bestScore = 0;

  areas.forEach(area=>{
    const score = calculateAreaScore(area);

    if(score > bestScore){
      bestArea = area;
      bestScore = score;
    }
  });

  return bestArea ? {area:bestArea, count:bestScore} : null;
}

function getAreaOptionRecommendation(areaName){

  const remaining = getRemainingWeapons();
  const target = normalizeText(areaName);

  // 1ï¸âƒ£ ì§€ì—­ ë¬´ê¸°ë§Œ
  const areaWeapons = remaining.filter(row=>{
    if(!row["ì§€ì—­"]) return false;

    const areas = String(row["ì§€ì—­"])
      .split(',')
      .map(a=>normalizeText(a));

    return areas.includes(target);
  });

  if(areaWeapons.length === 0) return null;

  /* ---------------------------------
     2ï¸âƒ£ ì˜µì…˜2+3 í†µí•© ë¹ˆë„ ê³„ì‚°
  --------------------------------- */

  const subCount = {};

  areaWeapons.forEach(row=>{
    [...parseOptions(row["ì˜µì…˜2"]), ...parseOptions(row["ì˜µì…˜3"])]
      .forEach(opt=>{
        subCount[opt] = (subCount[opt]||0)+1;
      });
  });

  // ìµœë‹¤ ë“±ì¥ íšŸìˆ˜
  const maxCount = Math.max(...Object.values(subCount));

  // ë™ë¥  í›„ë³´ë“¤
  const candidates = Object.entries(subCount)
    .filter(([opt,count])=>count===maxCount)
    .map(e=>e[0]);

  /* ---------------------------------
     3ï¸âƒ£ í›„ë³´ë³„ ì‹¤ì œ íŒŒë° íš¨ìœ¨ ê³„ì‚°
  --------------------------------- */

  let bestOption = null;
  let bestScore = -1;
  let bestTop3 = [];
  let bestTop3Count = {};

  candidates.forEach(option=>{

    // ì´ ì˜µì…˜ ê°€ì§„ ë¬´ê¸°ë§Œ
    const optionWeapons = areaWeapons.filter(row=>
      parseOptions(row["ì˜µì…˜2"]).includes(option) ||
      parseOptions(row["ì˜µì…˜3"]).includes(option)
    );

    // ì˜µì…˜1 ì¹´ìš´íŠ¸
    const primaryCount = {};

    optionWeapons.forEach(row=>{
      parseOptions(row["ì˜µì…˜1"]).forEach(opt=>{
        primaryCount[opt]=(primaryCount[opt]||0)+1;
      });
    });

    // ì˜µì…˜1 TOP3
    const top3 = Object.entries(primaryCount)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,3)
      .map(e=>e[0]);

    const top3Set = new Set(top3);

    // ì‹¤ì œ íŒŒë° íš¨ìœ¨ (í•µì‹¬)
    let score = 0;
    const top3HitCount = {};

  optionWeapons.forEach(row=>{

  const opt1List = parseOptions(row["ì˜µì…˜1"]);

  const hasTop3 =
    opt1List.some(opt=>top3Set.has(opt));

  if(hasTop3){

    score++;

    // â­ ì–´ë–¤ ì˜µì…˜1ì´ ì‹¤ì œ ëª‡ ë²ˆ ë“±ì¥í–ˆëŠ”ì§€ ê¸°ë¡
    opt1List.forEach(opt=>{
      if(top3Set.has(opt)){
        top3HitCount[opt] = (top3HitCount[opt]||0)+1;
      }
    });

  }
  });

    // ìµœê³  ì„ íƒ
    if(score > bestScore){
  bestScore = score;
  bestOption = option;
  bestTop3 = top3;
  bestTop3Count = top3HitCount;
  }

  });

  return {
    bestOption,
    top3: bestTop3,
    top3Count: bestTop3Count,
  score: bestScore
  };
}

function getRemainingWeapons(){
  return dbdata.filter(row => !excludedIds.has(row["ì´ë¦„"]));
}

function renderStats() {
      const statsEl = document.getElementById("stats-container");
  if (!statsEl || !currentResult || currentResult.length === 0) {
    if (statsEl) statsEl.innerHTML = "";
    return;
  }

  const mySelected = new Set();

  if (Array.isArray(selected.primary)) {
    selected.primary.forEach(v => mySelected.add(v.trim()));
  }

  ["secondary", "skill", "area"].forEach(type => {
    if (selected[type] && typeof selected[type] === "string") {
      mySelected.add(selected[type].trim());
    }})
};

function normalizeText(str){
  if(!str) return "";

  return str
    .toString()
    // ëª¨ë“  íŠ¹ìˆ˜ ê³µë°± ì œê±°
    .replace(/[\u200B-\u200D\uFEFF]/g, '')  // zero width
    .replace(/\u00A0/g,' ')                 // NBSP
    .replace(/\u2007/g,' ')
    .replace(/\u202F/g,' ')
    // ì¼ë°˜ ê³µë°± ì •ë¦¬
    .replace(/\s+/g,' ')
    .trim();
}

function updateOptionAvailability() {
  const types = ["primary", "secondary", "skill", "area"];

  types.forEach(type => {
    document.querySelectorAll(`#${type} .btn`).forEach(btn => {
      const value = btn.textContent;

      // 1. ì´ë¯¸ ë‚´ê°€ ëˆ„ë¥¸ ë²„íŠ¼ì€ ë¹„í™œì„±í™” ê³„ì‚° ì œì™¸
      const isSelected = type === "primary" 
        ? selected.primary.includes(value) 
        : selected[type] === value;
      
      if (isSelected) {
        btn.classList.remove("disabled");
        return;
      }
      // 2. ì´ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ê²°ê³¼ê°€ ë‚˜ì˜¬ ìˆ˜ ìˆëŠ”ì§€ ê²€ì‚¬
      const isPossible = dbdata.some(row => {
        if (excludedIds.has(row["ì´ë¦„"])) return false;

        return types.every(t => {
          let sel = (t === type) 
            ? (t === "primary" ? [...selected.primary, value] : value) 
            : selected[t];

          if (!sel || (Array.isArray(sel) && sel.length === 0)) return true;

          const rowOpts = [row["ì˜µì…˜1"], row["ì˜µì…˜2"], row["ì˜µì…˜3"]].filter(Boolean).map(v => v.trim());

          if (t === "area") {
  if(!row["ì§€ì—­"]) return false;

  const areas = String(row["ì§€ì—­"])
    .split(',')
    .map(a=>normalizeText(a));

  return areas.includes(normalizeText(sel));
  }

          // ğŸ”¥ ìˆ˜ì • í¬ì¸íŠ¸: Primary(ë°°ì—´)ëŠ” í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´(some) í™œì„±í™” ìœ ì§€
          if (Array.isArray(sel)) {
            return sel.some(s => rowOpts.includes(s.trim())); 
          }
                    return rowOpts.includes(sel.trim());
        });
      });
      btn.classList.toggle("disabled", !isPossible);
    });
  });
}

function clearType(type) {
  if (type === "primary") {
    selected[type] = [];
  } else {
    selected[type] = null;  
    }
  document.querySelectorAll(`#${type} .btn`)
    .forEach(b => b.classList.remove("active"));
}

function toggle(type, value, btn) {
  if (type === "primary") {
    // ğŸ”¥ Primary: ë‹¤ì¤‘ ì„ íƒ ë¡œì§
    const index = selected.primary.indexOf(value);
    if (index > -1) {
      selected.primary.splice(index, 1); // ì´ë¯¸ ìˆìœ¼ë©´ ì œê±°
      btn.classList.remove("active");
    } else {
      selected.primary.push(value); // ì—†ìœ¼ë©´ ì¶”ê°€
      btn.classList.add("active");
    }
  } else {
    // ğŸ¯ ë‚˜ë¨¸ì§€: ë‹¨ì¼ ì„ íƒ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    if (selected[type] === value) {
      selected[type] = null;
      btn.classList.remove("active");
    } else {
      selected[type] = value;
      document.querySelectorAll(`#${type} .btn`)
        .forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    }
  }
    updateResult();
  // ì•„ë˜ í•¨ìˆ˜ê°€ ë²„íŠ¼ì˜ disabled(ë¹„í™œì„±í™”)ë¥¼ ì œì–´í•©ë‹ˆë‹¤.
  updateOptionAvailability(); 
}

function exportToJSON() {
  const data = localStorage.getItem("excludedCards");
  if (!data) {
    alert("ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // 1. íŒŒì¼ ë‚´ìš© ìƒì„±
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  // 2. ê°€ìƒ ë§í¬ ì œì‘ ë° í´ë¦­ (ë‹¤ìš´ë¡œë“œ ì‹¤í–‰)
  const a = document.createElement("a");
  a.href = url;
  a.download = `excluded_backup_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();

  // 3. ë’·ì •ë¦¬
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importFromJSON(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const content = e.target.result;
      // ìœ íš¨í•œ JSONì¸ì§€ ê²€ì¦
      JSON.parse(content); 
      
      // localStorageì— ì €ì¥ ë° í™”ë©´ ê°±ì‹ 
      localStorage.setItem("excludedCards", content);
      alert("ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!");
      location.reload(); // ë³€ê²½ì‚¬í•­ ë°˜ì˜ì„ ìœ„í•´ ìƒˆë¡œê³ ì¹¨
    } catch (err) {
      alert("ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
    }
  };
  reader.readAsText(file);
}

</script>

</body>
</html>
